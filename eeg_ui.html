<!doctype html>
<html lang="de" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EEG‑Auswertung – Web UI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>html, body { height: 100%; } .glass { backdrop-filter: saturate(150%) blur(14px); } .mac-win { box-shadow: 0 10px 30px rgba(0,0,0,.08); } .soft-shadow { box-shadow: 0 8px 24px rgba(2,6,23,.08); } .ring-subtle { box-shadow: inset 0 0 0 1px rgba(148,163,184,.35); }</style>
</head>
<body class="h-full bg-gradient-to-b from-slate-100 to-slate-50 dark:from-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100 selection:bg-blue-200/60 dark:selection:bg-blue-400/30">
  <div class="max-w-7xl mx-auto px-4 py-8 sm:py-12">
    <div class="mac-win rounded-3xl overflow-hidden border border-slate-200/70 dark:border-slate-800/70 bg-white/70 dark:bg-slate-900/60 glass">
      <div class="flex items-center justify-between px-4 sm:px-6 py-3 border-b border-slate-200/70 dark:border-slate-800/70 bg-white/60 dark:bg-slate-900/50">
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <span class="inline-block w-3 h-3 rounded-full bg-red-500 ring-1 ring-red-600/40"></span>
            <span class="inline-block w-3 h-3 rounded-full bg-yellow-400 ring-1 ring-yellow-500/40"></span>
            <span class="inline-block w-3 h-3 rounded-full bg-green-500 ring-1 ring-green-600/40"></span>
          </div>
          <h1 class="text-base sm:text-lg font-semibold tracking-tight ml-3">EEG‑Auswertung</h1>
        </div>
        <div class="flex items-center gap-2">
          <div class="inline-flex rounded-2xl overflow-hidden ring-1 ring-slate-300/70 dark:ring-slate-700/70">
            <button id="themeLight" class="px-3 py-1.5 text-sm bg-white/80 dark:bg-transparent hover:bg-white dark:hover:bg-slate-800">Light</button>
            <button id="themeDark" class="px-3 py-1.5 text-sm bg-transparent hover:bg-white/70 dark:hover:bg-slate-800">Dark</button>
          </div>
          <a id="downloadCsvBtn" class="px-3 py-1.5 text-sm rounded-2xl ring-1 ring-slate-300/70 dark:ring-slate-700/70 hover:bg-white/70 dark:hover:bg-slate-800" href="#" download="summary_indices.csv" hidden>CSV</a>
          <button id="resetBtn" class="px-3 py-1.5 text-sm rounded-2xl ring-1 ring-slate-300/70 dark:ring-slate-700/70 hover:bg-white/70 dark:hover:bg-slate-800" type="button">Zurücksetzen</button>
        </div>
      </div>

      <div class="p-4 sm:p-6">
        <section class="rounded-2xl soft-shadow ring-subtle bg-white/70 dark:bg-slate-900/50 glass p-4 sm:p-6 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <h2 class="font-semibold mb-3">Datenquelle</h2>
              <div class="space-y-3 text-sm">
                <label class="block font-medium">ZIP mit Sessions</label>
                <input id="zipInput" type="file" accept=".zip" class="block w-full text-sm" />
                <div class="text-center text-slate-500">oder</div>
                <label class="block font-medium">Einzelne CSVs</label>
                <input id="csvInput" type="file" accept=".csv" multiple class="block w-full text-sm" />
              </div>
            </div>

            <div>
              <h2 class="font-semibold mb-3">Optionen</h2>
              <div class="grid grid-cols-2 gap-3 text-sm">
                <label class="inline-flex items-center gap-2"><input id="showTrend" type="checkbox" class="scale-110" checked> Trendlinien</label>
                <label class="inline-flex items-center gap-2"><input id="absoluteIdx" type="checkbox" class="scale-110"> Absolute Indizes</label>
                <label class="inline-flex items-center gap-2 col-span-2"><input id="groupDaily" type="checkbox" class="scale-110"> Pro Tag zusammenfassen</label>
                <label class="col-span-2">Glättungsfenster
                  <select id="smoothWin" class="mt-1 w-full rounded-xl border border-slate-300/80 dark:border-slate-700/80 bg-white/80 dark:bg-slate-900/60 px-3 py-2">
                    <option>3</option>
                    <option selected>5</option>
                    <option>7</option>
                    <option>9</option>
                    <option>11</option>
                  </select>
                </label>
              </div>
            </div>

            <div>
              <h2 class="font-semibold mb-3">Aktion</h2>
              <div class="flex flex-col gap-3">
                <button id="analyzeBtn" class="inline-flex items-center justify-center gap-2 rounded-2xl px-4 py-2 font-medium bg-slate-900 text-white hover:opacity-90 dark:bg-white dark:text-slate-900" type="button">Auswertung starten</button>
                <p id="status" class="text-sm text-slate-600 dark:text-slate-400"></p>
                <pre id="debugLog" class="text-xs text-slate-400 mt-2" style="max-height:160px; overflow:auto"></pre>
              </div>
            </div>
          </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="rounded-2xl soft-shadow ring-subtle bg-white/70 dark:bg-slate-900/50 glass p-3 sm:p-4">
            <div class="flex items-center justify-between px-1 pt-1 pb-2">
              <h3 class="font-semibold">Stress & Entspannung</h3>
              <button id="dlSR" class="px-3 py-1.5 text-xs rounded-xl" type="button" hidden>PNG</button>
            </div>
            <div id="chartSR" class="w-full rounded-xl overflow-hidden" style="height:420px"></div>
          </div>
          <div class="rounded-2xl soft-shadow ring-subtle bg-white/70 dark:bg-slate-900/50 glass p-3 sm:p-4">
            <div class="flex items-center justify-between px-1 pt-1 pb-2">
              <h3 class="font-semibold">Bänder + Stress‑/Entspannungswellen</h3>
              <button id="dlBands" class="px-3 py-1.5 text-xs rounded-xl" type="button" hidden>PNG</button>
            </div>
            <div id="chartBands" class="w-full rounded-xl overflow-hidden" style="height:420px"></div>
          </div>
        </section>

        <section class="rounded-2xl soft-shadow ring-subtle bg-white/70 dark:bg-slate-900/50 glass p-4 sm:p-6 mt-6">
          <h3 class="font-semibold mb-3">Sessions</h3>
          <div class="overflow-x-auto">
            <table id="tbl" class="min-w-full text-sm">
              <thead class="text-left text-slate-600 dark:text-slate-300"><tr>
                <th class="py-2 pr-4">Zeit</th><th class="py-2 pr-4">Delta</th><th class="py-2 pr-4">Theta</th>
                <th class="py-2 pr-4">Alpha</th><th class="py-2 pr-4">Beta</th><th class="py-2 pr-4">Gamma</th>
                <th class="py-2 pr-4">Stress</th><th class="py-2 pr-4">Entspannung</th><th class="py-2 pr-4">VM/Abend</th>
              </tr></thead>
              <tbody id="tblBody" class="divide-y divide-slate-200 dark:divide-slate-800"></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </div>

<script>
function getId(id){ return document.getElementById(id); }
const root = document.documentElement;
function status(msg){ getId('status').textContent = msg; }
function dbg(msg){ try{ const p=getId('debugLog'); p.textContent = msg + "
" + p.textContent; }catch(e){ console.log(msg); } }
function fmt(n, d=3){ return (n===undefined||n===null||Number.isNaN(n)) ? '' : Number(n).toFixed(d); }
function parseDateFromPath(p){ const m = /brainzz_([0-9]{4}-[0-9]{2}-[0-9]{2}--[0-9]{2}-[0-9]{2}-[0-9]{2})/i.exec(p); if(!m) return null; const parts = m[1].split('--'); const [Y, M, D] = parts[0].split('-').map(Number); const [h, mi, se] = parts[1].split('-').map(Number); return new Date(Date.UTC(Y, M-1, D, h, mi, se)); }
function toTTMMJJ(dt){ const dd = String(dt.getUTCDate()).padStart(2,'0'); const mm = String(dt.getUTCMonth()+1).padStart(2,'0'); const yy = String(dt.getUTCFullYear()).slice(-2); const HH = String(dt.getUTCHours()).padStart(2,'0'); const MM = String(dt.getUTCMinutes()).padStart(2,'0'); return `${dd}-${mm}-${yy} ${HH}:${MM}`; }
function movingAverage(arr, key, w){ const n = arr.length; const out = new Array(n).fill(null); for(let i=0;i<n;i++){ let s=0,c=0; for(let j=i-Math.floor(w/2); j<=i+Math.floor(w/2); j++){ if(j>=0&&j<n){ s+=arr[j][key]; c++; } } out[i]=(c>0)?s/c:null; } return out; }

async function readZip(file){ dbg(`readZip: ${file.name}`); const zip = await JSZip.loadAsync(file); const entries = [];
  // recursive walker
  async function walk(z, prefix){
    const names = Object.keys(z.files);
    for(const name of names){
      const f = z.files[name];
      if(f.dir) continue;
      const lower = name.toLowerCase();
      const full = prefix? (prefix + '/' + name) : name;
      if(lower.endsWith('.csv')){
        const txt = await f.async('string'); entries.push({ name: full, text: txt });
      } else if(lower.endsWith('.zip')){
        dbg(`found inner zip: ${full}, reading...`);
        const bytes = await f.async('uint8array');
        const inner = await JSZip.loadAsync(bytes);
        await walk(inner, full.replace(/\.zip$/i,''));
      }
    }
  }
  await walk(zip, ''); dbg(`entries total: ${entries.length}`); return entries;
}
async function readCsvFiles(fileList){ const entries=[]; for(const f of fileList){ const txt = await f.text(); entries.push({ name: f.name, text: txt }); } dbg(`readCsvFiles: ${entries.length}`); return entries; }
function parseCsvText(text){ const res = Papa.parse(text, { header:true, dynamicTyping:true, skipEmptyLines:true }); return res.data; }

function guessDatetimeFromRows(rows){ if(!rows||rows.length===0) return null; const sample = rows[0]; const keys = Object.keys(sample).map(k=>k.toLowerCase()); const cand=['datetime','timestamp','time','date','start_time']; for(const c of cand){ const k = keys.find(k=>k.includes(c)); if(k){ const val = sample[k]; const d = new Date(val); if(!isNaN(d)) return d; } } return null; }

function computeSessionFromRows(rows,name){ const bands=['Delta','Theta','Alpha','Beta','Gamma']; const sums={delta:[],theta:[],alpha:[],beta:[],gamma:[]}; if(!rows||rows.length===0){ dbg(`${name}: empty csv`); return null; }
  const cols = Object.keys(rows[0]??{});
  // accept both Delta_ prefix or exact Delta column names
  const bandFound = bands.some(B=> cols.some(c=> String(c).startsWith(B+'_') || String(c).toLowerCase()===B.toLowerCase()));
  if(!bandFound){ dbg(`${name}: no band columns found. cols: ${cols.slice(0,8).join(', ')}`); return null; }
  for(const row of rows){ let vals={delta:0,theta:0,alpha:0,beta:0,gamma:0}; for(const c of cols){ for(const B of bands){ if(String(c).startsWith(B+'_') || String(c).toLowerCase()===B.toLowerCase()){ const v = Number(row[c]); if(Number.isFinite(v)) vals[B.toLowerCase()]+=v; } } } const total = vals.delta+vals.theta+vals.alpha+vals.beta+vals.gamma; if(total>0){ sums.delta.push(vals.delta/total); sums.theta.push(vals.theta/total); sums.alpha.push(vals.alpha/total); sums.beta.push(vals.beta/total); sums.gamma.push(vals.gamma/total); } }
  if(sums.alpha.length===0){ dbg(`${name}: no valid band rows`); return null; }
  const mean = k=> sums[k].reduce((a,b)=>a+b,0)/sums[k].length; const alpha=mean('alpha'); const beta=mean('beta'); const theta=mean('theta'); const delta=mean('delta'); const gamma=mean('gamma');
  let dt = parseDateFromPath(name);
  if(!dt){ const guessed = guessDatetimeFromRows(rows); if(guessed){ dt = guessed; dbg(`${name}: guessed date from CSV -> ${toTTMMJJ(dt)}`); } else { dbg(`${name}: no date found (name+csv)`); return null; } }
  const stress = beta/(alpha+1e-9); const relax = alpha/(beta+1e-9); const tod = (dt.getUTCHours()<15)? 'Vormittag':'Abend'; return { dt, date_str: toTTMMJJ(dt), alpha, beta, theta, delta, gamma, stress, relax, tod };
}

function buildSummary(sessions, groupDaily){ const data=[...sessions].sort((a,b)=>a.dt-b.dt); if(!groupDaily) return data; const map=new Map(); for(const s of data){ const key = s.date_str.slice(0,8); if(!map.has(key)) map.set(key,[]); map.get(key).push(s); } const out=[]; for(const [key,arr] of map){ const avg=f=>arr.reduce((a,b)=>a+b[f],0)/arr.length; out.push({ dt:arr[0].dt, date_str:key, alpha:avg('alpha'), beta:avg('beta'), theta:avg('theta'), delta:avg('delta'), gamma:avg('gamma'), stress:avg('stress'), relax:avg('relax'), tod:'' }); } return out.sort((a,b)=>a.dt-b.dt); }

function plotTemplate(){ return root.classList.contains('dark')? 'plotly_dark':'plotly'; }
function relayoutTemplate(id){ Plotly.relayout(getId(id), {template: plotTemplate(), paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)'}); }
function drawStressRelax(summary,showTrend,absolute,win){ const x=summary.map(s=>s.date_str); const stress=absolute? summary.map(s=> s.beta/(s.alpha+1e-9)) : summary.map(s=> s.stress); const relax=absolute? summary.map(s=> s.alpha/(s.beta+1e-9)) : summary.map(s=> s.relax); const trendS = showTrend? movingAverage(summary.map((v,i)=>({val:stress[i]})).map(o=>({val:o.val})), 'val', win) : []; const trendR = showTrend? movingAverage(summary.map((v,i)=>({val:relax[i]})).map(o=>({val:o.val})), 'val', win) : []; const traces=[ {x,y:stress,type:'scatter',mode:'lines+markers',name:'Stress',line:{color:'rgb(239,68,68)'},marker:{size:6}}, {x,y:relax,type:'scatter',mode:'lines+markers',name:'Entspannung',line:{color:'rgb(34,197,94)'},marker:{size:6}} ]; if(showTrend){ traces.push({x,y:trendS,type:'scatter',mode:'lines',name:'Stress (Trend)',line:{color:'rgb(239,68,68)',dash:'dash'}}); traces.push({x,y:trendR,type:'scatter',mode:'lines',name:'Entspannung (Trend)',line:{color:'rgb(34,197,94)',dash:'dash'}}); } const layout={ title:{text:'Stress‑ & Entspannungs‑Index',x:0,xanchor:'left',font:{size:16}}, xaxis:{type:'category'}, margin:{l:40,r:24,t:40,b:40}, template:plotTemplate(), paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)'}; Plotly.newPlot('chartSR', traces, layout, {responsive:true,displaylogo:false,modeBarButtonsToRemove:['lasso2d','select2d']}); relayoutTemplate('chartSR'); getId('dlSR').hidden=false; }
function drawBands(summary,win){ const x=summary.map(s=>s.date_str); const series={ Delta:summary.map(s=>s.delta), Theta:summary.map(s=>s.theta), Alpha:summary.map(s=>s.alpha), Beta:summary.map(s=>s.beta), Gamma:summary.map(s=>s.gamma), 'Stress‑Welle (Beta+Gamma)':summary.map(s=>s.beta+s.gamma), 'Entspannungs‑Welle (Alpha+Theta)':summary.map(s=>s.alpha+s.theta) }; const traces=Object.entries(series).map(([name,y])=>({x,y,type:'scatter',mode:'lines+markers',name,marker:{size:6}})); const layout={ title:{text:'Bänder + Stress/Entspannungs‑Wellen',x:0,xanchor:'left',font:{size:16}}, xaxis:{type:'category'}, yaxis:{range:[0,1]}, margin:{l:40,r:24,t:40,b:40}, template:plotTemplate(), paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)'}; Plotly.newPlot('chartBands', traces, layout, {responsive:true,displaylogo:false,modeBarButtonsToRemove:['lasso2d','select2d']}); relayoutTemplate('chartBands'); getId('dlBands').hidden=false; }
function populateTable(summary){ const body=getId('tblBody'); body.innerHTML=''; for(const s of summary){ const tr=document.createElement('tr'); tr.innerHTML = ` <td class="py-2 pr-4">${s.date_str}</td> <td class="py-2 pr-4">${fmt(s.delta)}</td> <td class="py-2 pr-4">${fmt(s.theta)}</td> <td class="py-2 pr-4">${fmt(s.alpha)}</td> <td class="py-2 pr-4">${fmt(s.beta)}</td> <td class="py-2 pr-4">${fmt(s.gamma)}</td> <td class="py-2 pr-4">${fmt(s.stress)}</td> <td class="py-2 pr-4">${fmt(s.relax)}</td> <td class="py-2 pr-4">${s.tod||''}</td> `; body.appendChild(tr); } }
function buildCsv(summary){ const headers=['datetime','date_str','delta','theta','alpha','beta','gamma','stress','relax','tod']; const rows=summary.map(s=>[ s.dt.toISOString(), s.date_str, s.delta, s.theta, s.alpha, s.beta, s.gamma, s.stress, s.relax, s.tod ]); const csv=[headers.join(','), ...rows.map(r=>r.join(','))].join('
'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=getId('downloadCsvBtn'); a.href=url; a.hidden=false; }
function recolorPlots(){ ['chartSR','chartBands'].forEach(id=>{try{relayoutTemplate(id);}catch(e){}}); }

function setTheme(mode){ if(mode==='dark') root.classList.add('dark'); else root.classList.remove('dark'); recolorPlots(); }
getId('themeLight').addEventListener('click',()=>setTheme('light'));
getId('themeDark').addEventListener('click',()=>setTheme('dark'));
if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){ setTheme('dark'); }
getId('resetBtn').addEventListener('click',()=>window.location.reload());

getId('analyzeBtn').addEventListener('click', async ()=>{
  try{
    status('Lese Daten …'); dbg('--- start ---');
    const zipFile = getId('zipInput').files[0] || null; const csvFiles = getId('csvInput').files || null;
    let entries = [];
    if(zipFile){ const e = await readZip(zipFile); entries = entries.concat(e); }
    if(csvFiles && csvFiles.length){ const e2 = await readCsvFiles(csvFiles); entries = entries.concat(e2); }
    dbg(`total csv entries: ${entries.length}`);
    if(entries.length===0){ status('Keine Dateien gefunden.'); return; }
    const sessions = [];
    for(const {name,text} of entries){ try{ const rows = parseCsvText(text); if(!rows||rows.length===0){ dbg(`${name}: parse gave 0 rows`); continue; } dbg(`${name}: cols=${Object.keys(rows[0]).slice(0,12).join(', ')} rows=${rows.length}`); const sess = computeSessionFromRows(rows,name); if(sess){ sessions.push(sess); dbg(`${name}: ok -> ${sess.date_str}`); } }catch(err){ dbg(`${name}: parse error ${err.message}`); } }
    if(sessions.length===0){ status('Keine gültigen Sessions ermittelt. Sieh Debug-Log.'); return; }
    const groupDaily=getId('groupDaily').checked; const absolute=getId('absoluteIdx').checked; const showTrend=getId('showTrend').checked; const win=parseInt(getId('smoothWin').value,10);
    const summary = buildSummary(sessions, groupDaily);
    drawStressRelax(summary, showTrend, absolute, win);
    drawBands(summary, win);
    populateTable(summary);
    buildCsv(summary);
    status(`${summary.length} Session(s) verarbeitet.`);
    getId('dlSR').onclick = () => Plotly.downloadImage(getId('chartSR'), {format:'png', filename:'stress_relax'});
    getId('dlBands').onclick = () => Plotly.downloadImage(getId('chartBands'), {format:'png', filename:'bands'});
  }catch(e){ console.error(e); status('Fehler: '+e.message); dbg('fatal: '+e.message); }
});
</script>
</body>
</html>
